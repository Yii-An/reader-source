# Reader Source - 产品文档

## 产品愿景

为阅读类应用（如 Legado「阅读」、any-reader 等）提供一个统一的书源规则编辑和管理工具，简化规则创建、测试和跨平台转换的流程。

## 解决的问题

1. **格式碎片化** - 不同阅读器使用不同的书源格式，规则难以复用
2. **编辑困难** - 手动编写 JSON 规则容易出错，缺乏可视化工具
3. **测试不便** - 规则编写后需要导入阅读器才能验证，效率低下
4. **学习成本** - 不同平台的规则语法差异大，增加学习负担

## 核心功能

### 1. 书源列表管理

- 导入/导出书源（支持 any-reader 和 Legado 格式）
- 自动识别导入格式
- 批量管理和搜索过滤
- 本地持久化存储（IndexedDB）

### 2. 可视化规则编辑器

- 分类表单编辑：基本信息、搜索规则、章节规则、发现规则、正文规则、详情规则
- Monaco 代码编辑器支持（JSON/JavaScript）
- 平台特有字段分组显示
- 实时验证和提示

### 3. 格式转换引擎

- **通用规则 (UniversalRule)**：作为 any-reader 和 Legado 的超集
- **双向转换**：any-reader ↔ Universal ↔ Legado
- **表达式转换**：自动处理 CSS/XPath/JSONPath/JavaScript 语法差异
- **变量映射**：`$keyword` ↔ `{{keyword}}`、`$host` ↔ `{{baseUrl}}` 等

### 4. 规则测试面板

- **搜索测试**：输入关键词，测试搜索规则
- **发现测试**：测试发现页规则和分页
- **章节测试**：输入书籍 URL，测试目录规则
- **正文测试**：输入章节 URL，测试内容规则
- 实时日志输出
- 结果预览（支持图片代理绕过防盗链）

### 5. 批量测试（新增）

- **多书源并发测试**：同时测试多个书源的搜索功能
- **并发控制**：限制同时进行的测试数（默认 3 个）
- **状态追踪**：实时显示每个书源的测试状态（等待/进行中/成功/失败）
- **统计汇总**：成功/失败数量、总结果数
- **详情查看**：点击书源查看完整测试结果

### 6. 网页解析能力

- Puppeteer 无头浏览器（绕过 Cloudflare 验证）
- Cheerio HTML 解析
- 支持 XPath 和 CSS 选择器
- JavaScript 规则执行
- 图片代理（绕过防盗链）

## 用户体验目标

1. **直观易用** - 表单化编辑，降低学习门槛
2. **即时反馈** - 测试面板实时验证规则正确性
3. **无损转换** - 格式转换保留所有有效信息
4. **高效调试** - 日志面板记录详细执行过程

## 工作流程

```mermaid
graph TD
    A[导入书源 JSON] --> B{格式检测}
    B -->|any-reader| C[转换为 UniversalRule]
    B -->|Legado| C
    B -->|Universal| D[直接存储]
    C --> D
    D --> E[可视化编辑]
    E --> F[测试面板验证]
    F --> G{测试通过?}
    G -->|否| E
    G -->|是| H[导出]
    H --> I{选择格式}
    I -->|any-reader| J[导出 any-reader JSON]
    I -->|Legado| K[导出 Legado JSON]
```

## 支持的内容类型

| 类型 | 描述     | any-reader | Legado |
| ---- | -------- | ---------- | ------ |
| 小说 | 文字内容 | ✅ (1)     | ✅ (0) |
| 漫画 | 图片内容 | ✅ (0)     | ❌     |
| 视频 | 视频内容 | ✅ (2)     | ❌     |
| 音频 | 有声书   | ✅ (3)     | ✅ (1) |
| RSS  | 订阅源   | ✅ (4)     | ❌     |

## 界面布局

```
┌────────────────────────────────────────────────────────────┐
│ [工具栏] 新建 | 保存 | 导入 | 导出 | 清除         书源调试器 │
├──────────┬────────────────────────────┬────────────────────┤
│          │                            │                    │
│ 书源列表 │     规则编辑器              │    测试面板        │
│          │                            │                    │
│ - 搜索框 │ [基本信息] [搜索] [章节]...│ [搜索] [发现] ...  │
│ - 列表   │                            │                    │
│          │ 表单 / Monaco 编辑器       │ 输入 + 结果列表    │
│          │                            │                    │
├──────────┴────────────────────────────┴────────────────────┤
│ [日志面板]                                                  │
│ [INFO] 已加载书源「xxx」                                    │
│ [DEBUG] 请求 URL: https://...                              │
└────────────────────────────────────────────────────────────┘
```

## 目标用户画像

1. **阅读 App 用户** - 需要自定义书源以访问特定网站内容
2. **书源开发者** - 为社区制作和维护书源规则
3. **社区维护者** - 管理和分发书源规则集合
